# title:   reinon raksafirma
# author:  good micros
# desc:    short description
# site:    website link
# license: MIT License (change this to your license of choice)
# version: 0.1
# script:  python
from random import choice, randint
UP = 0
DOWN = 1
LEFT = 2
RIGHT = 3
SPEED = 1
GRID = 8
PROGMAX = 3 #progression cap to fix or break machine

machineStates = { #all machine states
    "ok" : {"tool":None,"better":"ok","worse":["broken","fire","sparks"],"sprite":35},
    "broken" : {"tool":"hammer","better":"ok","worse":["sparks"]*3+["fire"]+["destroyed"],"sprite":67},
    "sparks"  : {"tool": "multimeter","better":"broken","worse":["fire"]*4+["destroyed"],"sprite":99},
    "fire" : {"tool": "extinguisher","better":"broken","worse":["destroyed"],"sprite":131},
    "destroyed" : {"tool":None,"better":"destroyed","worse":["destroyed"],"sprite":163},
}

toolTypes = {
    "hammer":{"sprite":192},
    "multimeter":{"sprite":193},
    "extinguisher":{"sprite":194},
    "empty":{"sprite":195},
}

class tool():
    def __init__(self):
        self.type = None
        self.x =  0
        self.y = 0
        self.sprite = 18

    def use(self, player):
        t = player.tool
        player.tool = self.type

        if t != "empty":
            self.type = t
        else:
            self.x = -1
            self.y = -1

    def tick(self):
        self.sprite = toolTypes[self.type]["sprite"]

class machine():
    def __init__(self):
        self.status = "ok"
        self.progress = 0
        self.x = 0
        self.y = 0
        self.frame = 0
        self.sprite = 18

    def tick(self):
        #do nothing if already destroyed
        if self.status == "destroyed":
            self.sprite = machineStates[self.status]["sprite"]
            return

        #animate
        self.sprite = machineStates[self.status]["sprite"] + self.progress + int(self.frame)%2*16
        self.frame += 1/30 
    
    def use(self, player):
        #correct tool fixes machine, wrong makes it worse
        if player.tool == machineStates[self.status]["tool"]:
            self.progress += 1
            if self.progress > PROGMAX:
                self.status = machineStates[self.status]["better"]
                self.progress = 0
                player.score +=1
                return
        else:
            self.progress -= 1
            if self.progress < -PROGMAX:
                self.status = choice(machineStates[self.status]["worse"])
                self.progress = 0
                player.score -=1
                return

machines = tools = [machine()]
def newGame():
    global machines
    global tools
    #spawn machines
    machines = []
    for n in range(10):
        m = machine()
        m.status = choice(["broken","fire","sparks"])
        machines.append(m)

    #spawn tools
    tools = []
    toolPool = ["hammer", "extinguisher", "multimeter"]*2
    for n in toolPool:
        t = tool()
        t.type = n
        tools.append(t)

    #place all itmes in map
    for i in machines+tools:
        while True:
            x = randint(1,29)
            y = randint(1,16)
            if mget(x,y) != 0:
                continue
            i.x = x
            i.y = y
            break

    #set wall for machine
    for m in machines:
       mset(m.x,m.y,16)

#NPC to wreck machines
class destroyer():
    def __init__(self):
        self.score = 0
        self.tool = ""
d = destroyer()

newGame()

class player():
    def __init__(self, number):
        self.n = number #player number
        self.buttonOffset = 8 * (self.n - 1) #offset for controller selection
        self.x = 0
        self.y = 0
        self.facing = DOWN
        self.tool = "empty"
        self.score = 0
        
    def tick(self):
        x = 0
        y = 0

        #check for player input 
        if btn(UP + self.buttonOffset):
            y -= 1
        if btn(DOWN + self.buttonOffset):
            y += 1
        if btn(LEFT + self.buttonOffset):
            x -= 1
        if btn(RIGHT + self.buttonOffset):
            x += 1

        #horizontal move
        if x != 0:
            self.facing = LEFT if x < 0 else RIGHT
            x += self.x
            if mget(x//GRID,self.y//GRID) == 0:
                self.x = x

        #vertical move
        if y != 0:
            self.facing = UP if y < 0 else DOWN
            y = self.y + y
            if mget(self.x//GRID,y//GRID) == 0:
                self.y = y

        #"repair"
        if btnp(4 + self.buttonOffset):
            self.use()

    def use(self):
        x = self.x//GRID
        y = self.y//GRID

        if self.facing == UP:
            y -= 1
        elif self.facing == DOWN:
            y += 1
        elif self.facing == LEFT:
            x -= 1
        elif self.facing == RIGHT:
            x += 1

        for i in machines+tools:
            if i.x == x and i.y == y:
                i.use(self)

players = []
for n in range(4):
    p = player(n+1)
    p.x = 5*GRID + n*GRID
    p.y = 5*GRID
    players.append(p)

time = 0
rate = 60*2
matchTime = 0
def TIC():
    global players
    global machines
    global tools
    global d
    global time
    global rate
    global matchTime
    time += 1
    matchTime += 1

    #every once in a while make one machine worse
    if time > rate:
        time = 0
        if rate > 60:
            rate -= 1
        m = choice(machines)
        #if m.status != "ok":
        m.use(d)

    #start drawing
    cls()
    map()
    print(f"{matchTime//(60*60):02}:{matchTime//60%60:02}  {rate/60:.1f}",0,0)

    for i in machines+tools:
        i.tick()
        spr(i.sprite,i.x*GRID,i.y*GRID,colorkey=0)

    for p in players:
        p.tick()
        spr(p.n,p.x-GRID//2,p.y-GRID//2)

    for p in players:
        print(f"{p.score:03}",0,3*GRID+(p.n-1)*GRID*3)
        spr(toolTypes[p.tool]["sprite"],0,GRID+(p.n-1)*GRID*3,scale=2)

# <TILES>
# 001:eccccccccc888888caaaaaaaca888888caccc3cccacc0333cacc0333cacc0ccc
# 002:ccccceee8888cceeaaaa0cee888a0ceeccca0ccc0cca0c0c0cca0c0c0cca0c0c
# 003:eccccccccc888888caaaaaaaca888888cacccccccacccccccacc0ccccacc0ccc
# 004:ccccceee8888cceeaaaa0cee888a0ceeccca0cccccca0c0c0cca0c0c0cca0c0c
# 016:cccccccdcddddddecddddddecddddddedeeeeeefdeffffefdeffffefdeeeeeef
# 017:2232232233333333322322323333333323223223333333332232232233333333
# 018:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
# 019:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
# 020:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
# 032:0000000000000000000000000000000000000000000000000000000011111111
# 033:0000000000000000000000000000000000000000000000001111111111111111
# 034:0000000000000000000000000000000000000000111111111111111111111111
# 035:0000000000000000000000000000000011111111111111111111111111111111
# 036:0000000000000000000000001111111111111111111111111111111111111111
# 037:0000000000000000111111111111111111111111111111111111111111111111
# 038:0101010111111111111111111111111111111111111111111111111111111111
# 048:0000000000000000000000000000000000000000000000000000000022222222
# 049:0000000000000000000000000000000000000000000000002222222222222222
# 050:0000000000000000000000000000000000000000222222222222222222222222
# 051:0000000000000000000000000000000022222222222222222222222222222222
# 052:0000000000000000000000002222222222222222222222222222222222222222
# 053:0000000000000000222222222222222222222222222222222222222222222222
# 054:0202020222222222222222222222222222222222222222222222222222222222
# 064:0000000000000000000000000000000000000000000000000000000077777777
# 065:0000000000000000000000000000000000000000000000007777777777777777
# 066:0000000000000000000000000000000000000000777777777777777777777777
# 067:0000000000000000000000000000000077777777777777777777777777777777
# 068:0000000000000000000000007777777777777777777777777777777777777777
# 069:0000000000000000777777777777777777777777777777777777777777777777
# 070:0707070777777777777777777777777777777777777777777777777777777777
# 080:0000000000000000000000000000000000000000000000000000000066666666
# 081:0000000000000000000000000000000000000000000000006666666666666666
# 082:0000000000000000000000000000000000000000666666666666666666666666
# 083:0000000000000000000000000000000066666666666666666666666666666666
# 084:0000000000000000000000006666666666666666666666666666666666666666
# 085:0000000000000000666666666666666666666666666666666666666666666666
# 086:0606060666666666666666666666666666666666666666666666666666666666
# 096:00000000000000000000000000000000000000000000000000000000bbbbbbbb
# 097:000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbb
# 098:0000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbb
# 099:00000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
# 100:000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
# 101:0000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
# 102:0b0b0b0bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
# 112:00000000000000000000000000000000000000000000000000000000aaaaaaaa
# 113:000000000000000000000000000000000000000000000000aaaaaaaaaaaaaaaa
# 114:0000000000000000000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaa
# 115:00000000000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
# 116:000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
# 117:0000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
# 118:0a0a0a0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
# 128:0000000000000000000000000000000000000000000000000000000033333333
# 129:0000000000000000000000000000000000000000000000003333333333333333
# 130:0000000000000000000000000000000000000000333333333333333333333333
# 131:0000000000000000000000000000000033333333333333333333333333333333
# 132:0000000000000000000000003333333333333333333333333333333333333333
# 133:0000000000000000333333333333333333333333333333333333333333333333
# 134:0303030333333333333333333333333333333333333333333333333333333333
# 144:0000000000000000000000000000000000000000000000000000000022222222
# 145:0000000000000000000000000000000000000000000000002222222222222222
# 146:0000000000000000000000000000000000000000222222222222222222222222
# 147:0000000000000000000000000000000022222222222222222222222222222222
# 148:0000000000000000000000002222222222222222222222222222222222222222
# 149:0000000000000000222222222222222222222222222222222222222222222222
# 150:0202020222222222222222222222222222222222222222222222222222222222
# 160:00000000000000000000000000000000000000000000000000000000ffffffff
# 161:000000000000000000000000000000000000000000000000ffffffffffffffff
# 162:0000000000000000000000000000000000000000ffffffffffffffffffffffff
# 163:00000000000000000000000000000000ffffffffffffffffffffffffffffffff
# 164:000000000000000000000000ffffffffffffffffffffffffffffffffffffffff
# 165:0000000000000000ffffffffffffffffffffffffffffffffffffffffffffffff
# 166:0f0f0f0fffffffffffffffffffffffffffffffffffffffffffffffffffffffff
# 176:00000000000000000000000000000000000000000000000000000000eeeeeeee
# 177:000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeee
# 178:0000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeee
# 179:00000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
# 180:000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
# 181:0000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
# 182:0e0e0e0eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
# 192:0eeeeee0eeeeeeeeeeeeeeee0eeeeee000033000000330000003300000033000
# 193:04444440047777400477774004444440044f4f400444444004f4f44004444440
# 194:0ddddff0dd0dd0ff0002200f0022220f0022220f0022220f0022220f00222200
# 195:0000000000d0d0d000d0d0d000ddddd0dddddd0000dddd0000ffff000eeeeee0
# 196:cccccccdcddddddecddddddecddddddedeeeeeefdeffffefdeffffefdeeeeeef
# </TILES>

# <MAP>
# 000:111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 001:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 002:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 003:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 004:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 005:111100000000000000000000000000000000111111000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 006:111100000000000000000000000000001100000000111100000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 007:111100000000000000000000000000001100000000001111000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 008:111111111111111111111111000000001100000000000011000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 009:111100000000000000001100000000001100000000000011000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 010:111100000000000000001100000000110000000000001100000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 011:111100000000000000001100000000110000000000001100000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 012:111100000000000000001100000000111111111111111100000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 013:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 014:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 015:111100000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 016:111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# </MAP>

# <WAVES>
# 000:00000000ffffffff00000000ffffffff
# 001:0123456789abcdeffedcba9876543210
# 002:0123456789abcdef0123456789abcdef
# </WAVES>

# <SFX>
# 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
# </SFX>

# <TRACKS>
# 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# </TRACKS>

# <PALETTE>
# 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
# </PALETTE>

